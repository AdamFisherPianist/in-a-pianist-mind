<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nonlinear Piano Hammer — A Themed Exploration</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --card:#0f1720; --muted:#99a1ad; --accent:#ff7a59; --glass: rgba(255,255,255,0.04);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,#071018 0%,#08131b 60%); color:#e6eef6;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; padding:36px;
    }
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;gap:20px;align-items:center;margin-bottom:24px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .mark{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#ffb199);display:flex;align-items:center;justify-content:center;font-weight:700;color:#0b0f14;font-family:Merriweather;font-size:20px;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    h1{font-family:Merriweather,serif;font-size:28px;margin:0}
    .sub{color:var(--muted);font-size:14px}

    main{display:grid;grid-template-columns:1fr 380px;gap:28px}
    .card{background:linear-gradient(180deg,var(--card),#0b1722);padding:20px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(4,7,10,0.6);border:1px solid rgba(255,255,255,0.03)}

    .intro p{color:var(--muted);line-height:1.55}
    section h2{margin-top:0;font-size:18px}
    .equation{background:var(--glass);padding:12px;border-radius:10px;color:#eaf5ff;font-family:monospace;font-size:15px}

    /* controls */
    .controls{display:flex;flex-direction:column;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input[type=range]{width:100%}
    .row{display:flex;gap:12px;align-items:center}
    .small{font-size:13px;color:var(--muted)}

    /* canvas */
    .canvas-wrap{background:linear-gradient(180deg,#071017,rgba(255,255,255,0.01));padding:12px;border-radius:10px}
    canvas{width:100%;height:260px;background:linear-gradient(180deg,#051018,transparent);border-radius:8px;display:block}

    footer{margin-top:20px;color:var(--muted);font-size:13px}

    /* responsive */
    @media (max-width:980px){main{grid-template-columns:1fr;}
      .logo .mark{width:48px;height:48px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="mark">NH</div>
        <div>
          <h1>Nonlinear Hammer — Intuitive Demo</h1>
          <div class="sub">A styled, updated exploration of how hammer speed and material nonlinearity shape the piano's strike.</div>
        </div>
      </div>
    </header>

    <main>
      <div class="card">
        <section class="intro">
          <h2>Overview</h2>
          <p>This page explores a simplified, modern model of a piano hammer contacting a string. Instead of reproducing the original textbook page verbatim, the wording and visuals are refreshed for clarity and to match a contemporary visual theme.</p>
          <p>We use a compact nonlinear contact model: when the hammer hits, the instantaneous contact force <span style="color:var(--accent);font-weight:600">F</span> scales with penetration <span style="font-family:monospace">x</span> raised to an exponent <span style="font-family:monospace">n</span> (a typical choice is around 1.5).</p>
        </section>

        <section style="margin-top:18px">
          <h2>Core formulas</h2>
          <div class="equation">F(x) = k &middot; x<sup>n</sup></div>
          <div style="height:10px"></div>
          <div class="equation">For an impact at velocity v, effective peak force 
            <br> approx: <strong>F<sub>peak</sub> &asymp; C &middot; v<sup>m</sup></strong>
          </div>
          <p class="small" style="margin-top:8px">Here, <strong>k</strong> is a stiffness parameter, <strong>n</strong> controls nonlinearity of the contact, and <strong>m</strong> is an exponent relating hammer speed to peak force (depends on model details).</p>
        </section>

        <section style="margin-top:18px">
          <h2>Interactive model</h2>
          <p class="small">Adjust hammer velocity, stiffness and the nonlinearity exponent to see how the force curve and peak force change. Values here are illustrative, not a full physical simulation.</p>

          <div class="canvas-wrap card" style="padding:10px">
            <canvas id="plot"></canvas>
          </div>

          <div style="height:12px"></div>

          <div class="controls">
            <div>
              <label>Hammer velocity (m/s): <span id="velVal">2.0</span></label>
              <input id="velocity" type="range" min="0.2" max="6" step="0.1" value="2">
            </div>
            <div>
              <label>Stiffness k: <span id="kVal">1.0</span></label>
              <input id="stiffness" type="range" min="0.2" max="5" step="0.1" value="1">
            </div>
            <div>
              <label>Nonlinearity exponent n: <span id="nVal">1.5</span></label>
              <input id="exponent" type="range" min="1.0" max="3.0" step="0.05" value="1.5">
            </div>
            <div class="row small" style="justify-content:space-between;margin-top:6px">
              <div>Peak force: <strong id="peak">—</strong></div>
              <div>Contact duration (approx): <strong id="dur">—</strong></div>
            </div>
          </div>
        </section>

        <section style="margin-top:18px">
          <h2>Further Reading</h2>
          <p class="small">Explore more about piano acoustics and nonlinear hammer models in these resources:</p>
          <ul class="small" style="padding-left:18px;margin-top:6px;line-height:1.35;">
            <li><a href="https://adamfisherpianist.github.io/in-a-pianist-mind/struck.html" target="_blank" rel="noopener noreferrer" style="color: var(--accent);">In a Pianist’s Mind — Struck</a></li>
            <li><a href="https://www.acs.psu.edu/drussell/Piano/NonlinearHammer.html" target="_blank" rel="noopener noreferrer" style="color: var(--accent);">Original Penn State Hammer Model</a></li>
          </ul>
          <p class="small" style="margin-top:12px;">Built by Adam Erkouni Elidrissi</p>
        </section>
      </div>

      <aside class="card">
        <h2>Quick guide</h2>
        <p class="small">Try increasing velocity — peak force grows faster when the exponent <em>n</em> is larger. Decreasing stiffness reduces force magnitude. The plots below show force vs. penetration over a short contact window.</p>

        <div style="height:12px"></div>
        <div class="card" style="padding:10px">
          <h3 style="margin:0 0 8px 0;font-size:15px">Parameters</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div class="small">Velocity &ndash; how fast the hammer moves before contact.</div>
            <div class="small">Stiffness &ndash; how 'hard' the hammer material resists penetration.</div>
            <div class="small">Exponent n &ndash; controls nonlinearity (1 = linear, &gt;1 = stiffening contact).</div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div>
          <h3 style="margin:0 0 8px 0;font-size:15px">About this build</h3>
          <p class="small">Content wording refreshed. Visual theme inspired by a modern pianist's micro-site: dark, warm accent colors, soft cards, and clear interactive controls.</p>
        </div>

        <footer>
          <div>Made for learning • Not a professional instrument model • By Adam Erkouni Elidrissi</div>
        </footer>
      </aside>
    </main>
  </div>

  <!-- Audio element, make sure to have this file or update src -->
  <audio id="piano-sound" preload="auto" src="piano-strike.mp3"></audio>

  <script>
    // Setup canvas and context
    const canvas = document.getElementById('plot');
    const ctx = canvas.getContext('2d');

    // Resize canvas for high-DPI
    function setSize(){
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * devicePixelRatio;
      canvas.height = rect.height * devicePixelRatio;
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }

    setSize();
    window.addEventListener('resize', () => { setSize(); draw(); });

    // Controls & outputs
    const vel = document.getElementById('velocity');
    const k = document.getElementById('stiffness');
    const n = document.getElementById('exponent');
    const velVal = document.getElementById('velVal');
    const kVal = document.getElementById('kVal');
    const nVal = document.getElementById('nVal');
    const peakEl = document.getElementById('peak');
    const durEl = document.getElementById('dur');

    // Model: Force for penetration x
    function modelForce(x,kVal,nVal){
      return kVal * Math.pow(x, nVal);
    }

    // Approximate peak force and contact duration heuristics
    function computePeak(kv,nv,velv){
      const pen = Math.max(0.0001, velv/(kv*1.2));
      const Fpeak = kv * Math.pow(pen, nv);
      const duration = Math.max(0.001, 0.12 * Math.pow(pen, 0.5) / (Math.pow(kv,0.3)*(nv/1.2)));
      return {Fpeak, pen, duration};
    }

    // Variables for animation and ripple effect
    let rippleRadius = 0;
    let rippleAlpha = 0;
    let pulseTime = 0;
    let animationFrameId;

    function draw(){
      setSize();
      const W = canvas.width / devicePixelRatio;
      const H = canvas.height / devicePixelRatio;
      ctx.clearRect(0,0,W,H);

      // Draw ripple behind graph, fading out
      if(rippleAlpha > 0){
        ctx.beginPath();
        const rippleX = W*0.15 + (W-72) * 0.3;
        const rippleY = H-36;
        ctx.fillStyle = `rgba(255,122,89,${rippleAlpha})`;
        ctx.shadowColor = 'rgba(255,122,89,0.8)';
        ctx.shadowBlur = 12;
        ctx.arc(rippleX, rippleY, rippleRadius, 0, Math.PI * 2);
        ctx.fill();
        rippleRadius += 2;
        rippleAlpha -= 0.025;
      }

      // background grid
      ctx.fillStyle = 'rgba(255,255,255,0.02)';
      ctx.fillRect(0,0,W,H);

      // read params
      const kv = parseFloat(k.value);
      const nv = parseFloat(n.value);
      const velv = parseFloat(vel.value);

      // compute sample points for penetration x from 0 to maxPen*1.2
      const peakData = computePeak(kv,nv,velv);
      const maxPen = Math.max(peakData.pen*1.3, 0.02);
      const samples = 180;
      const xs = new Array(samples).fill(0).map((_,i)=> i/(samples-1)*maxPen );
      const Fs = xs.map(x=> kv * Math.pow(x, nv));
      const maxF = Math.max(...Fs,1e-6);

      // axes
      const pad = 36;
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.lineWidth = 1;
      // x axis
      ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
      // y axis
      ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(pad,pad); ctx.stroke();

      // labels
      ctx.fillStyle = 'rgba(230,238,246,0.9)'; ctx.font = '12px Inter';
      ctx.fillText('penetration (arb units)', W/2-50, H-10);
      ctx.save(); ctx.translate(10,H/2); ctx.rotate(-Math.PI/2); ctx.fillText('force (arb units)', 0,0); ctx.restore();

      // plot force curve
      ctx.beginPath();
      for(let i=0;i<xs.length;i++){
        const x = xs[i];
        const F = Fs[i];
        const px = pad + (W-2*pad) * (x / maxPen);
        const py = H - pad - (H-2*pad) * (F / maxF);
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.lineWidth = 2.4; ctx.strokeStyle = 'rgba(255,122,89,0.95)'; ctx.stroke();

      // draw peak marker with pulsing radius
      pulseTime += 0.03;
      const pulseRadius = 5 + 2 * Math.abs(Math.sin(pulseTime*3));
      const peakX = pad + (W-2*pad) * (peakData.pen / maxPen);
      const peakY = H - pad - (H-2*pad) * (peakData.Fpeak / maxF);
      ctx.fillStyle = 'rgba(255,255,255,0.98)';
      ctx.shadowColor = 'rgba(255,122,89,0.9)';
      ctx.shadowBlur = 14 * (0.6 + 0.4 * Math.abs(Math.sin(pulseTime*3)));
      ctx.beginPath(); ctx.arc(peakX,peakY,pulseRadius,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;

      // text summary in canvas
      ctx.fillStyle = 'rgba(230,238,246,0.9)'; ctx.font='13px Inter';
      ctx.fillText('peak ≈ ' + peakData.Fpeak.toFixed(3), pad+6, pad+14);
      ctx.fillText('penetration ≈ ' + peakData.pen.toFixed(3), pad+6, pad+30);

      // update side text
      peakEl.textContent = peakData.Fpeak.toFixed(3);
      durEl.textContent = peakData.duration.toFixed(3) + ' s';

      // Animate peak force text glow based on velocity
      const glowIntensity = 0.6 + 0.4 * Math.abs(Math.sin(pulseTime*5));
      peakEl.style.textShadow = `0 0 ${8 * glowIntensity}px rgba(255,122,89,${glowIntensity})`;

      animationFrameId = requestAnimationFrame(draw);
    }

    function triggerRipple() {
      rippleRadius = 8;
      rippleAlpha = 0.45;
    }

    // Audio interaction setup
    const audio = document.getElementById('piano-sound');
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let sourceNode = null;
    let gainNode = audioContext.createGain();
    gainNode.connect(audioContext.destination);

    async function loadAudio() {
      const response = await fetch(audio.src);
      const arrayBuffer = await response.arrayBuffer();
      return audioContext.decodeAudioData(arrayBuffer);
    }

    let audioBuffer;
    loadAudio().then(buffer => audioBuffer = buffer);

    function playStrike(velocity) {
      if (!audioBuffer) return;

      if (sourceNode) {
        sourceNode.stop();
        sourceNode.disconnect();
      }

      sourceNode = audioContext.createBufferSource();
      sourceNode.buffer = audioBuffer;
      sourceNode.connect(gainNode);

      const volume = Math.min(1, Math.max(0.1, velocity / 6));
      gainNode.gain.setValueAtTime(volume, audioContext.currentTime);

      sourceNode.start();
    }

    // Wire controls: play sound on velocity change + redraw
    vel.addEventListener('input', () => {
      velVal.textContent = parseFloat(vel.value).toFixed(1);
      kVal.textContent = parseFloat(k.value).toFixed(1);
      nVal.textContent = parseFloat(n.value).toFixed(2);
      triggerRipple();

      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      playStrike(parseFloat(vel.value));
    });

    // Other controls just redraw graph
    [k,n].forEach(el => el.addEventListener('input', () => {
      kVal.textContent = parseFloat(k.value).toFixed(1);
      nVal.textContent = parseFloat(n.value).toFixed(2);
    }));

    // Initial values & start draw loop
    velVal.textContent = parseFloat(vel.value).toFixed(1);
    kVal.textContent = parseFloat(k.value).toFixed(1);
    nVal.textContent = parseFloat(n.value).toFixed(2);
    draw();
  </script>
</body>
</html>
